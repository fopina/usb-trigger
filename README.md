# usb-trigger

`usb-trigger` is a simple utility that allows you to run custom commands or scripts whenever a USB device is attached or detached from your system. It works by listening to USB events and triggering actions based on device matching criteria (e.g., vendor ID, product ID).

## Why

`launchctl` allows running commands when a given USB device attaches or detaches such as

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC -//Apple Computer//DTD PLIST 1.0//EN http://www.apple.com/DTDs/PropertyList-1.0.dtd >
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.example.program</string>
    <key>ProgramArguments</key>
    <array>
    <string>/path/to/program</string>
    </array>
    <key>LaunchEvents</key>
    <dict>
            <key>com.apple.iokit.matching</key>
            <dict>
                    <key>com.apple.device-attach</key>
                    <dict>
                            <key>idProduct</key>
                            <integer>1234</integer>
                            <key>idVendor</key>
                            <integer>1337</integer>
                            <key>IOProviderClass</key>
                            <string>IOUSBDevice</string>
                            <key>IOMatchLaunchStream</key>
                            <true/>
                    </dict>
            </dict>
    </dict>
</dict>
</plist>
```

**HOWEVER** it requires some obj-C wrapper to call [xpc_set_event_stream_handler](https://developer.apple.com/library/mac/#documentation/Darwin/Reference/Manpages/man3/xpc_set_event_stream_handler.3.html), as there is no bash utility to do it **AND** it was only introduced in macOS 13 (I have one mac still on 12) **AND** it is sort of private API.

Hence, I decided to hit ChatGPT and it generated 100% of this code (with a few iterations), allowing me to efficiently run any script on USB attach/detach events in both my macOS 12 and my macOS 15 laptops.

Enjoy as well!

Rest of the README, also generated by ChatGPT.

## Features

- **Monitor USB events**: Tracks when USB devices are attached or detached.
- **Run custom commands**: Executes any script or command when a matching USB device is connected or removed.

## Installation

1. **Clone the repository**:

   ```bash
   git clone https://github.com/yourusername/usb-trigger.git
   ```

2. **Compile the program**:

    On macOS, compile the program using clang:

    ```bash
    clang -framework IOKit -framework Foundation -o usb-trigger usb-trigger.m
    ```

    This will create an executable named usb-trigger.

## Usage

### Running the Program

To run the program, provide the following arguments:
* Vendor ID (in hexadecimal format) of the target USB device.
* Product ID (in hexadecimal format) of the target USB device.
* Command: The command or script to run when the device is attached or detached (can include additional arguments).

```bash
./usb-trigger <VendorID> <ProductID> <Command...>
```

Example:

```bash
./usb-trigger 0x1234 0x5678 /path/to/script.sh arg1 arg2
```

This will trigger `/path/to/script.sh arg1 arg2` when a USB device with vendor ID `0x1234` and product ID `0x5678` is attached or detached.


### Setting the USB_EVENT environment variable

The tool automatically sets the `USB_EVENT` environment variable to either "attach" or "detach" before running your command. This can be useful for conditionally running parts of a script depending on whether the device was added or removed.

```
$USB_EVENT  # This will be "attach" or "detach"
```

### Example: Trigger a Notification Script

Let's say you want to send a notification when a specific USB device is attached:

```bash
./usb-trigger 0x1234 0x5678 /path/to/notify.sh
```

The notify.sh script might look like this:

```
#!/bin/bash

if [[ $USB_EVENT == "attach" ]]; then
  echo "USB device attached!"
else
  echo "USB device detached!"
fi
```

### Advanced Usage

You can use any shell script or command as the trigger. For example, to automatically mount a USB drive when connected, you could use a shell script that checks the `USB_EVENT` environment variable.

### Troubleshooting

* Ensure that you have permission to access USB device events on your system.
* If the program doesn't work as expected, check the logs for any errors, and make sure the device matching is correct (check your Vendor ID and Product ID).